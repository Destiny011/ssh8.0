
######################################################################################################################################################################################################
######################################################################################################################################################################################################
######################################################################################################################################################################################################

setenforce 0
tar -xvf openssh_update.tar
cd openssh_update
rpm -Uvh --force --nodeps *rpm
cd ..

######################################################################################################################################################################################################
######################################################################################################################################################################################################
######################################################################################################################################################################################################
tar -zxvf zlib-1.2.11.tar.gz
cd zlib-1.2.11
./configure --prefix=/usr/local/zlib-1.2.11 -share
make && make install
ln -s /usr/local/zlib-1.2.11 /usr/local/zlib
echo "/usr/local/zlib-1.2.11/lib" >> /etc/ld.so.conf
ldconfig -v
cd ..
######################################################################################################################################################################################################
######################################################################################################################################################################################################
######################################################################################################################################################################################################

tar -zxvf openssl-1.0.2m.tar.gz
cd openssl-1.0.2m
./config shared zlib-dynamic --prefix=/usr/local/openssl-1.0.2m --with-zlib-lib=/usr/local/zlib-1.2.11/lib --with-zlib-include=/usr/local/zlib-1.2.11/include
make && make install
ln -s /usr/local/openssl-1.0.2m /usr/local/openssl
echo "/usr/local/openssl-1.0.2m/lib" >> /etc/ld.so.conf   
ldconfig -v
openssl version -a
cd ..
######################################################################################################################################################################################################
######################################################################################################################################################################################################
######################################################################################################################################################################################################

tar -xzvf openssh-8.0p1.tar.gz
cd openssh-8.0p1
./configure --prefix=/usr/ --sysconfdir=/etc/ssh --with-pam --with-md5-passwords --with-tcp-wrappers --with-ssl-dir=/usr/local/openssl --with-zlib=/usr/local/zlib --mandir=/usr/share/man 
make && make install
sed -i '/UsePAM no/c\UsePAM yes' /etc/ssh/sshd_config
cp -p contrib/redhat/sshd.init /etc/init.d/sshd 
chmod +x /etc/init.d/sshd 
sed -i '/^Subsystem/c\Subsystem sftp /usr/libexec/sftp-server' /etc/ssh/sshd_config
sed -i '/^SELINUX=enforcing/c\SELINUX=disabled' /etc/selinux/config


######################################################################################################################################################################################################
######################################################################################################################################################################################################
######################################################################################################################################################################################################
chmod 600 /etc/ssh/ssh_host_ecdsa_key
chmod 600 /etc/ssh/ssh_host_rsa_key
chmod 600 /etc/ssh/ssh_host_ed25519_key
#####
sed -i '/^GSSAPIAuthentication/c\#GSSAPIAuthentication' /etc/ssh/sshd_config
sed -i '/^GSSAPICleanupCredentials/c\#GSSAPICleanupCredentials' /etc/ssh/sshd_config

mv  /usr/lib/systemd/system/sshd.service  /usr/lib/systemd/system/sshd
systemctl daemon-reload
/usr/sbin/sshd -p 22
sleep 2
systemctl restart sshd
